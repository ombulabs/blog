<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/Article">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


{"layout"=>"default", "title"=>"Adding Csrf-Protection to your Rails-Backbone App", "date"=>2015-12-16 00:55:00 -0300, "categories"=>["rails", "backbone", "security"], "author"=>"schmierkov", "url"=>"/rails/backbone/security/adding-csrf-protection-to-your-rails-backbone-app.html", "dir"=>"/rails/backbone/security", "id"=>"/rails/backbone/security/adding-csrf-protection-to-your-rails-backbone-app", "next"=><Post: /docker/rubygems/open-source/adding-docker-to-a-ruby-gem>, "previous"=><Post: /protractor/how-to-hide-elements-for-protractor-e2e-tests>, "tags"=>[], "path"=>"_posts/2015-12-16-adding-csrf-protection-to-your-rails-backbone-app.markdown", "content"=>"When integrating [Backbone.js](http://backbonejs.org) in your [Rails](http://rubyonrails.org) App, you might face the problem of the inability to verify the CSRF-Token.\n\nThe CSRF Protection secures your app with a token. Rails makes sure that the person who is interacting with your app is someone who started a session in your site, not some random attacker from another site. So you should not turn it off, unless you know what you are doing.\n\nFor more information on this Topic, check out the [Rails Security Guide](http://guides.rubyonrails.org/security.html#cross-site-request-forgery-csrf).\n\nThis problem occurs as soon as you are trying to send form data, without the CSRF-Token provided by Rails.\n\n```ruby\nStarted POST \"/products\" for 127.0.0.1 at 2015-12-16 10:06:05 -0300\nProcessing by ProductsController#create as JSON\n  Parameters: {\"product\"=>{\"name\"=>\"foo\"}}\nWARNING: Can't verify CSRF token authenticity\n...\nCompleted 302 Found in 7.6ms (ActiveRecord: 0.8ms)\n```\n\nAfter this request, Rails will terminate your session and you will have to login again.\n\nThis problem is caused by your Backbone.js application, which is sending the data directly to the backend without providing the CSRF-Token.\n\nTo solve this problem you need to add the token to your Backbone request. One of the simplest solutions I came across is the following by [Anton Shuvalov](https://github.com/shuvalov-anton/backbone-rails-sync).\n\n```javascript\n// https://github.com/shuvalov-anton/backbone-rails-sync\nBackbone._sync = Backbone.sync;\nBackbone.sync = function(method, model, options) {\n  if (!options.noCSRF) {\n    var beforeSend = options.beforeSend;\n\n    // Set X-CSRF-Token HTTP header\n    options.beforeSend = function(xhr) {\n      var token = $('meta[name=\"csrf-token\"]').attr('content');\n      if (token) { xhr.setRequestHeader('X-CSRF-Token', token); }\n      if (beforeSend) { return beforeSend.apply(this, arguments); }\n    };\n  }\n  return Backbone._sync(method, model, options);\n};\n```\n\nIt grabs the CSRF-Token provided in the meta tags of your Rails application and sets it for the request header field `X-CSRF-Token`.\n\nAfter adding this to the Backbone code, it works as expected.\n\n```ruby\nStarted POST \"/products\" for 127.0.0.1 at 2015-12-16 10:08:29 -0300\nProcessing by ProductsController#create as JSON\n  Parameters: {\"product\"=>{\"name\"=>\"foo\"}}\n...\nCompleted 200 OK in 40.6ms (Views: 0.6ms | ActiveRecord: 10.3ms)\n```\n", "excerpt"=>"<p>When integrating <a href=\"http://backbonejs.org\">Backbone.js</a> in your <a href=\"http://rubyonrails.org\">Rails</a> App, you might face the problem of the inability to verify the CSRF-Token.</p>\n\n<p>The CSRF Protection secures your app with a token. Rails makes sure that the person who is interacting with your app is someone who started a session in your site, not some random attacker from another site. So you should not turn it off, unless you know what you are doing.</p>\n\n<p>For more information on this Topic, check out the <a href=\"http://guides.rubyonrails.org/security.html#cross-site-request-forgery-csrf\">Rails Security Guide</a>.</p>\n\n<p>This problem occurs as soon as you are trying to send form data, without the CSRF-Token provided by Rails.</p>\n<div class=\"highlight\"><pre><code class=\"language-ruby\" data-lang=\"ruby\"><span class=\"no\">Started</span> <span class=\"no\">POST</span> <span class=\"s2\">&quot;/products&quot;</span> <span class=\"k\">for</span> <span class=\"mi\">127</span><span class=\"o\">.</span><span class=\"mi\">0</span><span class=\"o\">.</span><span class=\"mi\">0</span><span class=\"o\">.</span><span class=\"mi\">1</span> <span class=\"n\">at</span> <span class=\"mi\">2015</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">16</span> <span class=\"mi\">10</span><span class=\"p\">:</span><span class=\"mo\">06</span><span class=\"p\">:</span><span class=\"mo\">05</span> <span class=\"o\">-</span><span class=\"mo\">0300</span>\n<span class=\"no\">Processing</span> <span class=\"n\">by</span> <span class=\"no\">ProductsController</span><span class=\"c1\">#create as JSON</span>\n  <span class=\"ss\">Parameters</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"s2\">&quot;product&quot;</span><span class=\"o\">=&gt;</span><span class=\"p\">{</span><span class=\"s2\">&quot;name&quot;</span><span class=\"o\">=&gt;</span><span class=\"s2\">&quot;foo&quot;</span><span class=\"p\">}}</span>\n<span class=\"ss\">WARNING</span><span class=\"p\">:</span> <span class=\"no\">Can</span><span class=\"err\">&#39;</span><span class=\"n\">t</span> <span class=\"n\">verify</span> <span class=\"no\">CSRF</span> <span class=\"n\">token</span> <span class=\"n\">authenticity</span>\n<span class=\"o\">.</span><span class=\"n\">.</span><span class=\"o\">.</span>\n<span class=\"no\">Completed</span> <span class=\"mi\">302</span> <span class=\"no\">Found</span> <span class=\"k\">in</span> <span class=\"mi\">7</span><span class=\"o\">.</span><span class=\"mi\">6</span><span class=\"n\">ms</span> <span class=\"p\">(</span><span class=\"ss\">ActiveRecord</span><span class=\"p\">:</span> <span class=\"mi\">0</span><span class=\"o\">.</span><span class=\"mi\">8</span><span class=\"n\">ms</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>After this request, Rails will terminate your session and you will have to login again.</p>\n\n<p>This problem is caused by your Backbone.js application, which is sending the data directly to the backend without providing the CSRF-Token.</p>\n\n<p>To solve this problem you need to add the token to your Backbone request. One of the simplest solutions I came across is the following by <a href=\"https://github.com/shuvalov-anton/backbone-rails-sync\">Anton Shuvalov</a>.</p>\n<div class=\"highlight\"><pre><code class=\"language-javascript\" data-lang=\"javascript\"><span class=\"c1\">// https://github.com/shuvalov-anton/backbone-rails-sync</span>\n<span class=\"nx\">Backbone</span><span class=\"p\">.</span><span class=\"nx\">_sync</span> <span class=\"o\">=</span> <span class=\"nx\">Backbone</span><span class=\"p\">.</span><span class=\"nx\">sync</span><span class=\"p\">;</span>\n<span class=\"nx\">Backbone</span><span class=\"p\">.</span><span class=\"nx\">sync</span> <span class=\"o\">=</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">method</span><span class=\"p\">,</span> <span class=\"nx\">model</span><span class=\"p\">,</span> <span class=\"nx\">options</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nx\">options</span><span class=\"p\">.</span><span class=\"nx\">noCSRF</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"kd\">var</span> <span class=\"nx\">beforeSend</span> <span class=\"o\">=</span> <span class=\"nx\">options</span><span class=\"p\">.</span><span class=\"nx\">beforeSend</span><span class=\"p\">;</span>\n\n    <span class=\"c1\">// Set X-CSRF-Token HTTP header</span>\n    <span class=\"nx\">options</span><span class=\"p\">.</span><span class=\"nx\">beforeSend</span> <span class=\"o\">=</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">xhr</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"kd\">var</span> <span class=\"nx\">token</span> <span class=\"o\">=</span> <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">&#39;meta[name=&quot;csrf-token&quot;]&#39;</span><span class=\"p\">).</span><span class=\"nx\">attr</span><span class=\"p\">(</span><span class=\"s1\">&#39;content&#39;</span><span class=\"p\">);</span>\n      <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">token</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"nx\">xhr</span><span class=\"p\">.</span><span class=\"nx\">setRequestHeader</span><span class=\"p\">(</span><span class=\"s1\">&#39;X-CSRF-Token&#39;</span><span class=\"p\">,</span> <span class=\"nx\">token</span><span class=\"p\">);</span> <span class=\"p\">}</span>\n      <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">beforeSend</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"k\">return</span> <span class=\"nx\">beforeSend</span><span class=\"p\">.</span><span class=\"nx\">apply</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">,</span> <span class=\"nx\">arguments</span><span class=\"p\">);</span> <span class=\"p\">}</span>\n    <span class=\"p\">};</span>\n  <span class=\"p\">}</span>\n  <span class=\"k\">return</span> <span class=\"nx\">Backbone</span><span class=\"p\">.</span><span class=\"nx\">_sync</span><span class=\"p\">(</span><span class=\"nx\">method</span><span class=\"p\">,</span> <span class=\"nx\">model</span><span class=\"p\">,</span> <span class=\"nx\">options</span><span class=\"p\">);</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n<p>It grabs the CSRF-Token provided in the meta tags of your Rails application and sets it for the request header field <code>X-CSRF-Token</code>.</p>\n\n<p>After adding this to the Backbone code, it works as expected.</p>\n<div class=\"highlight\"><pre><code class=\"language-ruby\" data-lang=\"ruby\"><span class=\"no\">Started</span> <span class=\"no\">POST</span> <span class=\"s2\">&quot;/products&quot;</span> <span class=\"k\">for</span> <span class=\"mi\">127</span><span class=\"o\">.</span><span class=\"mi\">0</span><span class=\"o\">.</span><span class=\"mi\">0</span><span class=\"o\">.</span><span class=\"mi\">1</span> <span class=\"n\">at</span> <span class=\"mi\">2015</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">16</span> <span class=\"mi\">10</span><span class=\"p\">:</span><span class=\"mi\">08</span><span class=\"p\">:</span><span class=\"mi\">29</span> <span class=\"o\">-</span><span class=\"mo\">0300</span>\n<span class=\"no\">Processing</span> <span class=\"n\">by</span> <span class=\"no\">ProductsController</span><span class=\"c1\">#create as JSON</span>\n  <span class=\"ss\">Parameters</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"s2\">&quot;product&quot;</span><span class=\"o\">=&gt;</span><span class=\"p\">{</span><span class=\"s2\">&quot;name&quot;</span><span class=\"o\">=&gt;</span><span class=\"s2\">&quot;foo&quot;</span><span class=\"p\">}}</span>\n<span class=\"o\">.</span><span class=\"n\">.</span><span class=\"o\">.</span>\n<span class=\"no\">Completed</span> <span class=\"mi\">200</span> <span class=\"no\">OK</span> <span class=\"k\">in</span> <span class=\"mi\">40</span><span class=\"o\">.</span><span class=\"mi\">6</span><span class=\"n\">ms</span> <span class=\"p\">(</span><span class=\"ss\">Views</span><span class=\"p\">:</span> <span class=\"mi\">0</span><span class=\"o\">.</span><span class=\"mi\">6</span><span class=\"n\">ms</span> <span class=\"o\">|</span> <span class=\"ss\">ActiveRecord</span><span class=\"p\">:</span> <span class=\"mi\">10</span><span class=\"o\">.</span><span class=\"mi\">3</span><span class=\"n\">ms</span><span class=\"p\">)</span>\n</code></pre></div>", "disqus"=>true, "archive"=>false, "post_class"=>"post-template"}
schmierkov
    <title>Adding Csrf-Protection to Your Rails-Backbone App - The Lean Software Boutique</title>


    
    
    <meta name="description" content="When integrating Backbone.js in your Rails App, you might face the problem of the inability to verify the CSRF-Token.The CSRF Protection secures your app with a token. Rails makes sure that the person who is interacting with your app is someone who started a session in your site, not some random attacker from another site. So you should not turn it off, unless you know what you are doing.For more information on this Topic, check out the Rails Security Guide.This problem occurs as soon as you are trying to send form data, without the CSRF-Token provided by Rails.Started POST &quot;/products&quot; for 127.0.0.1 at 2015-12-16 10:06:05 -0300Processing by ProductsController#create as JSON  Parameters: {&quot;product&quot;=&gt;{&quot;name&quot;=&gt;&quot;foo&quot;}}WARNING: Can&#39;t verify CSRF token authenticity...Completed 302 Found in 7.6ms (ActiveRecord: 0.8ms)After this request, Rails will terminate your session and you will have to login again.This problem is caused by your Backbone.js application, which is sending the data directly to the backend without providing the CSRF-Token.To solve this problem you need to add the token to your Backbone request. One of the simplest solutions I came across is the following by Anton Shuvalov.// https://github.com/shuvalov-anton/backbone-rails-syncBackbone._sync = Backbone.sync;Backbone.sync = function(method, model, options) {  if (!options.noCSRF) {    var beforeSend = options.beforeSend;    // Set X-CSRF-Token HTTP header    options.beforeSend = function(xhr) {      var token = $(&#39;meta[name=&quot;csrf-token&quot;]&#39;).attr(&#39;content&#39;);      if (token) { xhr.setRequestHeader(&#39;X-CSRF-Token&#39;, token); }      if (beforeSend) { return beforeSend.apply(this, arguments); }    };  }  return Backbone._sync(method, model, options);};It grabs the CSRF-Token provided in the meta tags of your Rails application and sets it for the request header field X-CSRF-Token.After adding this to the Backbone code, it works as expected.Started POST &quot;/products&quot; for 127.0.0.1 at 2015-12-16 10:08:29 -0300Processing by ProductsController#create as JSON  Parameters: {&quot;product&quot;=&gt;{&quot;name&quot;=&gt;&quot;foo&quot;}}...Completed 200 OK in 40.6ms (Views: 0.6ms | ActiveRecord: 10.3ms)" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Schema.org markup for Google+ -->
    <meta itemprop="name" content="Adding Csrf-Protection to your Rails-Backbone App by @schmierkov">
    <meta itemprop="description" content="When integrating Backbone.js in your Rails App, you might face the problem of the inability to verify the CSRF-Token. The CSRF Protection secures your app with a token. Rails makes sure that the person who is interacting with your app is someone who started a session in your site, not...">
    <!-- meta itemprop="image" content="http://www.example.com/image.jpg" -->

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@OmbuLabs">

    <meta name="twitter:title" content="Adding Csrf-Protection to your Rails-Backbone App by @schmierkov">
    <meta name="twitter:description" content="When integrating Backbone.js in your Rails App, you might face the problem of the inability to verify the CSRF-Token. The CSRF Protection secures your app with a token. Rails makes sure that the person who is interacting with your app is someone who started a session in your site, not...">
    <meta name="twitter:creator" content="@OmbuLabs">
    <!-- Twitter summary card with large image must be at least 280x150px -->
    <!-- meta name="twitter:image:src" content="http://www.example.com/image.html" -->

    <!-- Open Graph data -->
    <meta property="og:title" content="Adding Csrf-Protection to Your Rails-Backbone App - The Lean Software Boutique" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="http://www.ombulabs.com/rails/backbone/security/adding-csrf-protection-to-your-rails-backbone-app.html" />
    <meta property="og:image" content="http://www.ombulabs.com/assets/isotype.png" />
    <meta property="og:description" content="When integrating Backbone.js in your Rails App, you might face the problem of the inability to verify the CSRF-Token. The CSRF Protection secures your app with a token. Rails makes sure that the person who is interacting with your app is someone who started a session in your site, not..." />
    <meta property="og:site_name" content="Adding Csrf-Protection to your Rails-Backbone App by @schmierkov" />
    
      <meta property="article:published_time" content="2015-12-16 00:55:00 -0300" />
      <meta property="article:modified_time" content="2015-12-16 00:55:00 -0300" />
      <meta property="article:section" content="When integrating Backbone.js in your Rails App, you might face the problem of the inability to verify the CSRF-Token. The CSRF Protection secures your app with a token. Rails makes sure that the person who is interacting with your app is someone who started a session in your site, not..." />
      <meta property="article:tag" content="Adding Csrf-Protection to Your Rails-Backbone App - The Lean Software Boutique" />
    

    <meta property="fb:admins" content="10153304864537860" />

    <link rel="stylesheet" type="text/css" href="/blog/assets/css/screen.css" />
    <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,900,300italic,400italic,700italic|Maven+Pro" rel="stylesheet" type="text/css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/blog/assets/css/main.css" />
    <link rel="stylesheet" type="text/css" href="/assets/ombulabs_blog.css" />
</head>
<body class="post-template">
  <header class="main-header no-cover">
      <nav class="main-nav overlay clearfix">
              
              <a class="back-button icon-arrow-left"
                 href="/blog">Home</a>
          <a class="subscribe-button icon-feed" href="/blog/rss.xml">Subscribe</a>
      </nav>
      <div class="vertical">
          <div class="main-header-content inner">
              <h1 class="page-title logo"><a href="/blog">OmbuLabs Blog</a></h1>
              <h2 class="page-description slogan">
                   The Lean Software Boutique 
                  
              </h2>
          </div>
      </div>
      <a class="scroll-down icon-arrow-left" href="#content" data-offset="-45"><span class="hidden">Scroll Down</span></a>
  </header>

    <main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Adding Csrf-Protection to your Rails-Backbone App</h1>
            <section class="post-meta">
              
              


  
    <img class="author-thumb" src="http://2.gravatar.com/avatar/ff0ffbb39659d36ad6aabcd0b4715c1b?s=50" alt="Sirko Sittig" nopin="nopin" />
  
  <a href="/blog/authors/schmierkov"
     title="Articles by Sirko Sittig">
     Sirko Sittig
  </a>


 
  on
    
      <a href="/blog/tags/rails"
         title="Articles about Rails">Rails</a>,
      <a href="/blog/tags/backbone"
         title="Articles about Backbone">Backbone</a>,
      <a href="/blog/tags/security"
         title="Articles about Security">Security</a>



<time class="post-date" datetime="2015-12-16">
  16 Dec 2015
</time>

            </section>
        </header>

        <section class="post-content">
          <p>When integrating <a href="http://backbonejs.org">Backbone.js</a> in your <a href="http://rubyonrails.org">Rails</a> App, you might face the problem of the inability to verify the CSRF-Token.</p>

<p>The CSRF Protection secures your app with a token. Rails makes sure that the person who is interacting with your app is someone who started a session in your site, not some random attacker from another site. So you should not turn it off, unless you know what you are doing.</p>

<p>For more information on this Topic, check out the <a href="http://guides.rubyonrails.org/security.html#cross-site-request-forgery-csrf">Rails Security Guide</a>.</p>

<p>This problem occurs as soon as you are trying to send form data, without the CSRF-Token provided by Rails.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Started</span> <span class="no">POST</span> <span class="s2">&quot;/products&quot;</span> <span class="k">for</span> <span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">16</span> <span class="mi">10</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mo">05</span> <span class="o">-</span><span class="mo">0300</span>
<span class="no">Processing</span> <span class="n">by</span> <span class="no">ProductsController</span><span class="c1">#create as JSON</span>
  <span class="ss">Parameters</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;product&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;foo&quot;</span><span class="p">}}</span>
<span class="ss">WARNING</span><span class="p">:</span> <span class="no">Can</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">verify</span> <span class="no">CSRF</span> <span class="n">token</span> <span class="n">authenticity</span>
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="no">Completed</span> <span class="mi">302</span> <span class="no">Found</span> <span class="k">in</span> <span class="mi">7</span><span class="o">.</span><span class="mi">6</span><span class="n">ms</span> <span class="p">(</span><span class="ss">ActiveRecord</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">8</span><span class="n">ms</span><span class="p">)</span>
</code></pre></div>
<p>After this request, Rails will terminate your session and you will have to login again.</p>

<p>This problem is caused by your Backbone.js application, which is sending the data directly to the backend without providing the CSRF-Token.</p>

<p>To solve this problem you need to add the token to your Backbone request. One of the simplest solutions I came across is the following by <a href="https://github.com/shuvalov-anton/backbone-rails-sync">Anton Shuvalov</a>.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// https://github.com/shuvalov-anton/backbone-rails-sync</span>
<span class="nx">Backbone</span><span class="p">.</span><span class="nx">_sync</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span><span class="p">;</span>
<span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">noCSRF</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">beforeSend</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">beforeSend</span><span class="p">;</span>

    <span class="c1">// Set X-CSRF-Token HTTP header</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">beforeSend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;meta[name=&quot;csrf-token&quot;]&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-CSRF-Token&#39;</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">beforeSend</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">beforeSend</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">_sync</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>It grabs the CSRF-Token provided in the meta tags of your Rails application and sets it for the request header field <code>X-CSRF-Token</code>.</p>

<p>After adding this to the Backbone code, it works as expected.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Started</span> <span class="no">POST</span> <span class="s2">&quot;/products&quot;</span> <span class="k">for</span> <span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">16</span> <span class="mi">10</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">29</span> <span class="o">-</span><span class="mo">0300</span>
<span class="no">Processing</span> <span class="n">by</span> <span class="no">ProductsController</span><span class="c1">#create as JSON</span>
  <span class="ss">Parameters</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;product&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;foo&quot;</span><span class="p">}}</span>
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="no">Completed</span> <span class="mi">200</span> <span class="no">OK</span> <span class="k">in</span> <span class="mi">40</span><span class="o">.</span><span class="mi">6</span><span class="n">ms</span> <span class="p">(</span><span class="ss">Views</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">6</span><span class="n">ms</span> <span class="o">|</span> <span class="ss">ActiveRecord</span><span class="p">:</span> <span class="mi">10</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>
</code></pre></div>
        </section>

        

        <footer class="post-footer">
          
            
            <figure class="author-image">
              
                <a class="img" href="" style="background-image: url(http://2.gravatar.com/avatar/ff0ffbb39659d36ad6aabcd0b4715c1b?s=50)">
                <span class="hidden">Sirko Sittig's Picture</span></a>
              
            </figure>
            <section class="author">
              <h4> Sirko Sittig </h4>
              <p>
                We are the Lean Software Boutique. Check us out at <a href="http://www.ombulabs.com">www.ombulabs.com</a>
              </p>
            </section>
          

          <!-- Share links section -->
          <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text=Adding Csrf-Protection to your Rails-Backbone App&amp;url=http://www.ombulabs.com/rails/backbone/security/adding-csrf-protection-to-your-rails-backbone-app.html"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://www.ombulabs.com/rails/backbone/security/adding-csrf-protection-to-your-rails-backbone-app.html"
        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://www.ombulabs.com/rails/backbone/security/adding-csrf-protection-to-your-rails-backbone-app.html"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

          <!-- Disqus comments -->
          
            <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">

        var disqus_shortname = 'ombulabs';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

          

        </footer>

    </article>

</main>

    <footer class="site-footer clearfix">
      <section class="copyright">
        <figure>
          <img src="/blog/assets/images/creative-commons.png"
               alt="Creative Commons Attribution-NonCommercial">
          <figcaption>
            <a href="http://creativecommons.org/licenses/by-nc/3.0/"
               target="_blank"
               title="Creative Commons Attribution-NonCommercial">Creative Commons Attribution-NonCommercial</a>
          </figcaption>
        </figure>
      </section>
      <section class="poweredby">Made with love using Jekyll and
        <a href="http://github.com/rosario/kasper">Kasper theme</a>
      </section>
    </footer>

    <script type="text/javascript" src="/blog/assets/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/blog/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/blog/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-17795190-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</body>
</html>
